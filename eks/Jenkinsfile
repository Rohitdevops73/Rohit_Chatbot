pipeline{
    parameters{
       choice (name:'terraformActions' , choices: ['apply','destroy'], description: 'choose your terraform action')
    }
    environment{
        AWS_ACCESS_KEY_ID = credentials('AWS_ACCESS_KEY_ID')
        AWS_SECRET_ACCESS_KEY = credentials('AWS_SECRET_ACCESS_KEY')

    }
    agent any
    stages{
        stage('Checkout'){
            steps{
                dir("terraform"){
                    git url: 'https://github.com/Rohitdevops73/Rohit_Chatbot.git' , branch: 'IAC-devenv'
                    // }    
                }     
            }
        }
        stage('Plan'){
            steps{
                sh 'pwd; cd eks/; terraform init'
                sh 'pwd; cd eks/; terraform plan -out tfplan'
                sh 'pwd; cd eks/; terraform show -no-color tfplan > tfplan.txt'
            }
        }
        stage('Approval'){
            steps{
                script{
                    def plan = readFile 'eks/tfplan.txt'
                    input message: "Do you want to proceed with terraform actions..?",
                    parameters: [text(name: 'Plan',description: 'Please review your plan',defaultValue: plan)]
                }
            }
        }
        stage('Apply/Destroy'){
            when {
                expression {
                    return params.terraformActions == 'apply' || params.terraformActions == 'destroy'
                }
            }
            steps{
                script{
                    if (params.terraformActions == 'apply'){
                        sh 'pwd; cd eks/; terraform apply -input=false tfplan'
                    }
                    else if (params.terraformActions == 'destroy'){
                        sh 'pwd; cd eks/; terraform destroy -auto-approve'
                    }
                }
            }
        }
      stage('Backup Terraform State') {
            steps {
        script {
            def bucketName = "rohitchatbot-terraform-backup-bucket"
            def region     = "ap-south-1" 
            def statePath  = "eks/terraform.tfstate"
            def s3Prefix   = "chat-bot/eks/"

            sh """
            # Check if bucket exists
            if ! aws s3api head-bucket --bucket ${bucketName} 2>/dev/null; then
                echo "Bucket does not exist. Creating bucket: ${bucketName}"

                # Create bucket
                aws s3api create-bucket \\
                    --bucket ${bucketName} \\
                    --region ${region} \\
                    --create-bucket-configuration LocationConstraint=${region}

                echo "Bucket created successfully: ${bucketName}"

                # Enable versioning
                aws s3api put-bucket-versioning \\
                    --bucket ${bucketName} \\
                    --versioning-configuration Status=Enabled

                echo "Versioning enabled on bucket: ${bucketName}"
            else
                echo "Bucket already exists: ${bucketName}"
            fi

            # Upload the state file
            aws s3 cp ${statePath} s3://${bucketName}/${s3Prefix}
            """
        }
      }
}
    }

}
    

